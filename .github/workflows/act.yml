name: RunsItself

on:
  push:
    branches:
      - develop

jobs:
  integration_tests_development:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@f1d3225b5376a0791fdee5a0e8eac5289355e43a # pin@v2
        with:
          fetch-depth: 2
      - name: Set up SSH
        run: |
          mkdir -p $HOME/.ssh/
          echo "$SSH_PRIVATE_KEY" > $HOME/.ssh/$DEPLOY_KEY_FILE
          echo "Wrote to $HOME/.ssh/$DEPLOY_KEY_FILE"
          echo "$SSH_KNOWN_HOSTS" > $HOME/.ssh/known_hosts
          chmod 600 $HOME/.ssh/$DEPLOY_KEY_FILE
          echo "$SSH_KNOWN_HOSTS" > $HOME/.ssh/known_hosts
          ls -al $HOME/.ssh
        shell: bash
        env:
          HOME: ${{env.HOME}}
          SSH_PRIVATE_KEY: ${{secrets.SSH_PRIVATE_KEY}}
          DEPLOY_KEY_FILE: ${{env.DEPLOY_KEY_FILE}}
          SSH_KNOWN_HOSTS: ${{env.DEPLOY_HOST}}

      - name: Create env file
        run: |
          touch $HOME/.ssh/config
          echo 'Host $DEPLOY_HOST' >> $HOME/.ssh/config
          echo 'IdentitiesOnly yes' >> $HOME/.ssh/config
          echo 'Port 22' >> $HOME/.ssh/config
          echo 'User $DEPLOY_USER' >> $HOME/.ssh/config
          echo "HostName $SSH_KNOWN_HOSTS" >> $HOME/.ssh/config
          echo 'IdentityFile $HOME/.ssh/$DEPLOY_KEY_FILE' >> $HOME/.ssh/config
        shell: bash
        env:
          DEPLOY_USER: ${{env.DEPLOY_USER}}
          DEPLOY_HOST: ${{env.DEPLOY_HOST}}
          SSH_KNOWN_HOSTS: ${{secrets.SSH_KNOWN_HOSTS}}
          DEPLOY_KEY_FILE: ${{env.DEPLOY_KEY_FILE}}

      - uses: ffflabs/pm2-action@08d2f7d5f45d49d2f6311171394ccdbfdd0df95b # pin@master
        with:
          environment: ${{ env.DEPLOY_ENVIRONMENT }}
          host: ${{ env.DEPLOY_HOST }}
          path: ${{ env.DEPLOY_PATH }}
          repo: ${{ env.DEPLOY_REPO_URL }}
          user: ${{ env.DEPLOY_USER }}
          key: ${{env.HOME}}/.ssh/${{env.DEPLOY_KEY_FILE}}
          ref: ${{ env.DEPLOY_BRANCH }}
          post-deploy: ${{env.POST_DEPLOY}}
          command: ${{env.DEPLOY_COMMAND}}
